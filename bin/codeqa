#!/usr/bin/env ruby

require 'rubygems'
require 'codeqa'

require "optparse"

options = { :silent => false, :failfast => true }

ARGV.options do |opts|
  opts.banner = "Usage:  #{File.basename($PROGRAM_NAME)} [OPTIONS] FILES"

  opts.separator ""
  opts.separator "Specific Options:"

  opts.on("-s", "--silent", "No output if no error") do |opt|
    options[:silent] = true
  end
  # opts.on( "-ss", "--silent-success", "No output if not error" ) do |opt|
  #   options[:silent] = true
  # end
  opts.on("-f", "--fail-fast", "Fail right after the first error.") do |opt|
    options[:failfast] = true
  end

  opts.separator "Common Options:"

  opts.on("-h", "--help",
          "Show this message.") do
    puts opts
    exit
  end

  begin
    opts.parse!
  rescue
    puts opts
    exit
  end
end

files_to_check = ARGV.reject{|e| Codeqa.config.excluded?(e)}
puts "#{files_to_check.count} files to check"
if options[:failfast]
  exit 1 unless files_to_check.all?{|e| Codeqa.check(e, options)}
else
  exit 1 unless files_to_check.map{|e| Codeqa.check(e, options)}.all?
end
